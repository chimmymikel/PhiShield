{% extends "phishield/base.html" %}

{% block title %}Change Password - PhiShield{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row justify-content-center">
        <div class="col-lg-6 col-md-8">
            <div class="card shadow-sm">
                <div class="card-header bg-transparent border-bottom-0">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="mb-0 text-dark fw-bold"><i class="fas fa-lock me-2"></i>Change Password</h5>
                            <p class="text-muted mb-0 small">Secure your account with a new password</p>
                        </div>
                        <a href="{% url 'phishield:profile' %}" class="btn btn-outline-secondary btn-sm">
                            <i class="fas fa-times me-1"></i>Cancel
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    <form method="POST">
                        {% csrf_token %}
                        
                        <!-- Current Password -->
                        <div class="mb-4">
                            <label for="current_password" class="form-label fw-bold">
                                <i class="fas fa-key me-1 text-primary"></i>Current Password
                            </label>
                            <input type="password" class="form-control" id="current_password" name="current_password" 
                                   placeholder="Enter your current password" required>
                            <small class="form-text text-muted">You must confirm your current password to make changes</small>
                        </div>

                        <!-- New Password -->
                        <div class="mb-4">
                            <label for="new_password" class="form-label fw-bold">
                                <i class="fas fa-lock me-1 text-success"></i>New Password
                            </label>
                            <input type="password" class="form-control" id="new_password" name="new_password" 
                                   placeholder="Enter your new password" required>
                            <div class="password-strength mt-2">
                                <div class="progress" style="height: 4px;">
                                    <div class="progress-bar" id="password-strength-bar" style="width: 0%"></div>
                                </div>
                                <small class="form-text text-muted" id="password-strength-text">
                                    Password strength: Very Weak
                                </small>
                            </div>
                            <div class="password-requirements mt-2">
                                <small class="text-muted">Requirements:</small>
                                <ul class="list-unstyled mt-1 small">
                                    <li id="req-length" class="text-danger">
                                        <i class="fas fa-times me-1"></i>At least 8 characters
                                    </li>
                                    <li id="req-uppercase" class="text-danger">
                                        <i class="fas fa-times me-1"></i>One uppercase letter
                                    </li>
                                    <li id="req-lowercase" class="text-danger">
                                        <i class="fas fa-times me-1"></i>One lowercase letter
                                    </li>
                                    <li id="req-number" class="text-danger">
                                        <i class="fas fa-times me-1"></i>One number
                                    </li>
                                </ul>
                            </div>
                        </div>

                        <!-- Confirm New Password -->
                        <div class="mb-4">
                            <label for="confirm_password" class="form-label fw-bold">
                                <i class="fas fa-lock me-1 text-info"></i>Confirm New Password
                            </label>
                            <input type="password" class="form-control" id="confirm_password" name="confirm_password" 
                                   placeholder="Confirm your new password" required>
                            <small class="form-text text-muted" id="password-match-text"></small>
                        </div>

                        <!-- Security Tips -->
                        <div class="alert alert-info bg-light border-0">
                            <h6 class="alert-heading fw-bold"><i class="fas fa-shield-alt me-1"></i>Password Security Tips</h6>
                            <ul class="mb-0 small">
                                <li>Use a combination of letters, numbers, and symbols</li>
                                <li>Avoid using personal information or common words</li>
                                <li>Consider using a passphrase for better security</li>
                                <li>Never reuse passwords across different services</li>
                            </ul>
                        </div>

                        <div class="d-flex justify-content-between align-items-center pt-3 border-top">
                            <a href="{% url 'phishield:profile' %}" class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-left me-1"></i>Back to Profile
                            </a>
                            <button type="submit" class="btn btn-primary" id="submit-btn" disabled>
                                <i class="fas fa-save me-1"></i>Update Password
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const currentPassword = document.getElementById('current_password');
    const newPassword = document.getElementById('new_password');
    const confirmPassword = document.getElementById('confirm_password');
    const strengthBar = document.getElementById('password-strength-bar');
    const strengthText = document.getElementById('password-strength-text');
    const submitBtn = document.getElementById('submit-btn');
    const matchText = document.getElementById('password-match-text');

    function checkPasswordStrength(password) {
        let strength = 0;
        const requirements = {
            length: password.length >= 8,
            uppercase: /[A-Z]/.test(password),
            lowercase: /[a-z]/.test(password),
            number: /[0-9]/.test(password)
        };

        // Update requirement indicators
        document.getElementById('req-length').className = requirements.length ? 'text-success' : 'text-danger';
        document.getElementById('req-length').innerHTML = `<i class="fas fa-${requirements.length ? 'check' : 'times'} me-1"></i>At least 8 characters`;
        
        document.getElementById('req-uppercase').className = requirements.uppercase ? 'text-success' : 'text-danger';
        document.getElementById('req-uppercase').innerHTML = `<i class="fas fa-${requirements.uppercase ? 'check' : 'times'} me-1"></i>One uppercase letter`;
        
        document.getElementById('req-lowercase').className = requirements.lowercase ? 'text-success' : 'text-danger';
        document.getElementById('req-lowercase').innerHTML = `<i class="fas fa-${requirements.lowercase ? 'check' : 'times'} me-1"></i>One lowercase letter`;
        
        document.getElementById('req-number').className = requirements.number ? 'text-success' : 'text-danger';
        document.getElementById('req-number').innerHTML = `<i class="fas fa-${requirements.number ? 'check' : 'times'} me-1"></i>One number`;

        // Calculate strength
        if (requirements.length) strength += 25;
        if (requirements.uppercase) strength += 25;
        if (requirements.lowercase) strength += 25;
        if (requirements.number) strength += 25;

        // Update strength bar and text
        strengthBar.style.width = strength + '%';
        
        if (strength < 25) {
            strengthBar.className = 'progress-bar bg-danger';
            strengthText.textContent = 'Password strength: Very Weak';
        } else if (strength < 50) {
            strengthBar.className = 'progress-bar bg-warning';
            strengthText.textContent = 'Password strength: Weak';
        } else if (strength < 75) {
            strengthBar.className = 'progress-bar bg-info';
            strengthText.textContent = 'Password strength: Good';
        } else {
            strengthBar.className = 'progress-bar bg-success';
            strengthText.textContent = 'Password strength: Strong';
        }

        return strength;
    }

    function checkFormValidity() {
        const isStrong = checkPasswordStrength(newPassword.value) >= 75;
        const passwordsMatch = newPassword.value === confirmPassword.value && newPassword.value !== '';
        const hasCurrentPassword = currentPassword.value !== '';
        
        if (isStrong && passwordsMatch && hasCurrentPassword) {
            submitBtn.disabled = false;
        } else {
            submitBtn.disabled = true;
        }
    }

    newPassword.addEventListener('input', checkFormValidity);
    confirmPassword.addEventListener('input', function() {
        if (newPassword.value === confirmPassword.value && newPassword.value !== '') {
            matchText.textContent = 'Passwords match!';
            matchText.className = 'form-text text-success';
        } else if (confirmPassword.value !== '') {
            matchText.textContent = 'Passwords do not match';
            matchText.className = 'form-text text-danger';
        } else {
            matchText.textContent = '';
        }
        checkFormValidity();
    });
    currentPassword.addEventListener('input', checkFormValidity);
});
</script>
{% endblock %}